<!DOCTYPE html>
<html     xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org">>
    <head>
        <meta charset="UTF-8">
        <title>Chuck Quotis</title>
        <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <link rel="stylesheet" href="assets/styles/style.css">

    </head>
    <body>
        <div class="container-lg container-fluid ">
            <div class="row bg-danger shadow py-4">
            <div class="col text-white">
                <h1 class="text-center mb-0">Chuck Quotis</h1>
                <div class="text-center">
                    <span>The ultimate Chuck Norris Quotes collection</span>
                </div> 
            </div> 
        </div>
        <div class="row bg-danger justify-content-center" sec:authorize="isAuthenticated()">
 			Authenticated as <span sec:authentication="name"></span>
            <a class="nav-item nav-link active text-white" href="/home">Home</a>
            <a class="nav-item nav-link text-white" href="profile.html">Profile</a>
            <a class="nav-item nav-link text-white" href="quote.html">Quotes</a>
            <a class="nav-item nav-link text-white" href="posts.html">Posts</a>
            <a class="nav-item nav-link text-white" href="/login?logout">Log Out</a>
          </div>
        <div class="row mt-3 shadow p-2">
            <div class="d-flex align-items-center col-lg-2 col-12">
                <button id="change-view-btn" class="btn btn-danger text-center btn-block lg-btn my-2 my-lg-0" style="display: none;">Change View</button>
            </div>
            <div class="d-flex align-items-center col-lg-4 col-12 justify-content-center">
            <div class="d-flex align-items-center">
                <span class="text-danger h4">Category: </span>
            </div>
            <form class="d-flex align-items-center">
                <div class="custom-control custom-radio mx-2">
                    <input type="radio" id="customRadio1" name="limit" value="nerdy" class="custom-control-input">
                    <label class="custom-control-label text-danger h6" for="customRadio1">Nerdy</label>
                  </div>
                  <div class="custom-control custom-radio mx-2">
                    <input type="radio" id="customRadio2" name="limit" value="explicit"class="custom-control-input">
                    <label class="custom-control-label text-danger h6" for="customRadio2">Explicit</label>
                  </div>
                  <div class="custom-control custom-radio mx-2">
                    <input type="radio" id="customRadio3" name="limit" value="all" class="custom-control-input">
                    <label class="custom-control-label text-danger h6" for="customRadio3">All</label>
                  </div>
            </form>
            
        </div>
        <div class="d-flex align-items-center col-lg-4 col-12 justify-content-center">
            <div class="d-flex align-items-center">
                <span class="text-danger h4">Filter: </span>
            </div>
            <form class="d-flex align-items-center">
                <div class="custom-control custom-radio mx-2">
                    <input type="radio" id="customRadio4" name="filter" value="custom" class="custom-control-input">
                    <label class="custom-control-label text-danger h6" for="customRadio4">Custom</label>
                  </div>
                  <div class="custom-control custom-radio mx-2">
                    <input type="radio" id="customRadio5" name="filter" value="saved"class="custom-control-input">
                    <label class="custom-control-label text-danger h6" for="customRadio5">Saved</label>
                  </div>
                  <div class="custom-control custom-radio mx-2">
                    <input type="radio" id="customRadio6" name="filter" value="all" class="custom-control-input">
                    <label class="custom-control-label text-danger h6" for="customRadio6">All</label>
                  </div>
            </form>
            
        </div>
        </div>
            <div class="row mt-3 d-flex mx-0 mx-lg-0">
                <div id="quote-container" class="col-lg-9 d-flex flex-wrap col-12 justify-content-center order-2 order-lg-1">
                   <!-- <div class="panel panel-default hidden-sm hidden-xs d-inline-flex">-->
                      

                          <!--<div class="card shadow m-2 card-quote">
                            <img class="card-img-top img-fluid" src="assets/images/2.jpg" alt="Card image cap">
                            <div class="card-body">
                              <span class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</span>
                            </div>
                          </div>

                          <div class="card shadow m-2 card-quote">
                            <img class="card-img-top img-fluid" src="assets/images/3.jpg" alt="Card image cap">
                            <div class="card-body">
                            <span class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</span>
                            </div>
                          </div>
                          <div class="card shadow m-2 card-quote">
                            <img class="card-img-top img-fluid" src="assets/images/3.jpg" alt="Card image cap">
                            <div class="card-body">
                            <span class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</span>
                            </div>
                          </div>

                          <div class="d-flex border-top">
                            <img class="card-img-top img-fluid thumbnail" src="assets/images/3.jpg" alt="Card image cap">
                            <div class="card-body">
                            <span class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</span>
                            </div>
                          </div>
                          <div class="d-flex border-top">
                            <img class="card-img-top img-fluid thumbnail" src="assets/images/3.jpg" alt="Card image cap">
                            <div class="card-body">
                            <span class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</span>
                            </div>
                          </div>
                          <div class="d-flex border-top">
                            <img class="card-img-top img-fluid thumbnail" src="assets/images/3.jpg" alt="Card image cap">
                            <div class="card-body">
                            <span class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</span>
                            </div>
                          </div> -->
                   <!--- </div>-->

                </div>
                <div class="col-lg-3 col-12 pr-0 mt-2 order-1">
                    <div class="shadow p-3">
                    <div class="row">
                        <div class="col">
                            <h3 class="text-center text-danger">Personalised Quote</h3>
                    <form class="">
                        <div class="form-group">
                            <label for="first-name" class="text-danger">First Name:</label>
                            <div class="input-group">
                                
                                <input type="text" class="form-control" id="first-name" placeholder="First Name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="last-name" class="text-danger">Last Name:</label>
                            <div class="input-group">
                                
                                <input type="text" class="form-control"  id="last-name" placeholder="Last Name">
                            </div>
                        </div>
                        <div class="text-center">
                        <button id="submit-personalised-quote" type="button" class="btn btn-danger" disabled>Generate Quote</button>
                        </div>
                    </form>
                    </div>
                    </div>
                    <div id="personalised-quote-container" class="row bg-danger text-wrap text-center m-3 p-1 result-container">
                        <div class="col">
                            <i class="fas fa-quote-left text-white"></i>
                            <span id="result-personalised-quote" class="text-white"> Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span>
                            <i class="fas fa-quote-right text-white"></i>
                        </div>
                    </div>
                </div>
                <div class="shadow p-3 mt-3">
                    <div class="row">
                        <div class="col">
                            <h3 class="text-center text-danger">Random Quote</h3>
                        <div class="text-center">
                        <button id="submit-random-quote" type="button" class="btn btn-danger">Generate Quote</button>
                        </div>
                    </div>
                    </div>
                    <div id="random-quote-container" class="row bg-danger text-wrap text-center m-3 p-1 result-container">
                        <div class="col">
                            <i class="fas fa-quote-left text-white"></i>
                            <span id="result-random-quote" class="text-white"> Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span>
                            <i class="fas fa-quote-right text-white"></i>
                        </div>
                    </div>
                </div>
                    <div class="shadow p-3 mt-3">
                    <div class="row">
                        <div class="col">
                            <h3 class="text-center text-danger">Create a Custom Quote</h3>
                    <form class="">
                        <div class="form-group">
                            <label for="custom-quote-text" class="text-danger">Quote Text:</label>
                            <div class="input-group">
                                
                                <textarea class="form-control" id="custom-quote-text" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="text-center">
                        <button id="submit-custom-quote" type="button" class="btn btn-danger">Create Quote</button>
                        </div>
                    </form>
                    </div>
                    </div>
                </div>

                </div>
            </div>
            
        </div>



        <div id="card-template" style="display: none; height: fit-content;" class="card shadow m-2 card-quote">
            <img class="card-img-top img-full-size" src="" alt="Card image cap">
            <div class="card-body">
            <span class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</span>
          </div>
            <div class="text-center">
            <button class="btn btn-success btn-act mb-3 mx-2" type="button">Save</button>
            <button class="btn btn-primary   mb-3 mx-2" type="button">Share</button>
            </div>
        </div>





        <script src="assets/js/jquery/jquery-3.5.1.js"></script>
       <!--<script src="assets/js/main.js"></script>-->
        
    </body>
    <script>
  /// <reference path="../typings/tsd.d.ts" /
    var hasLName = false;
    var hasFName = false;
    $(document).ready(function(){
    $("#random-quote-container").hide();
    $("#personalised-quote-container").hide();

        function doApiRequest(type){       
            $.ajax({
               method: "GET",
               url: QueryBuilder(type),
               dataType: "json"
            }).done(function(response){
            	
                switch(type){
                    case "random": getRandomQuote(response.value.joke); break;
                    case "": getAllQuotes(response.value);break;
                    case "personalised": getPersonalisedQuote(response.value.joke); break;
                }
            }).fail(function(){
                console.log("Something went wrong")
            })
    }
    function getAllQuotes(data){
        clearAllQuotes();
        showChangeViewButton();
        for (i=0;i<data.length;i++){
        var template = $('#card-template').clone();
        template.attr('id', 'quote-card-'+i);
        template.find('span').text(decodeEntities(data[i].joke));
        var text = template.find('span').text()
        var img = template.find('img');
        (function(i){
		$.ajax({
    		url: "/quote/issaved",
    		method: "POST",
    		data : {
    			text : decodeEntities(data[i].joke)
    		},
    		success : function(response){
    			if(response == true){
    			//$('#quote-card-'+i).find('.btn-success').attr("disabled", true);
    				$('#quote-card-'+i).find('.btn-act').html("Remove");
    				$('#quote-card-'+i).find('.btn-act').addClass("btn-danger");
    				$('#quote-card-'+i).find('.btn-act').removeClass("btn-success");
    			}
    			else{
    			//$('#quote-card-'+i).find('.btn-success').removeAttr("disabled");
    				$('#quote-card-'+i).find('.btn-act').html("Save");
    				$('#quote-card-'+i).find('.btn-act').addClass("btn-success");
    				$('#quote-card-'+i).find('.btn-act').removeClass("btn-danger");
    				
    				
    			}
    		},
    		fail : function(){
    			alert("Something went terribly wrong!!!")
    		}
    	})
        })(i);
        
        generateImage(img);
        /*$('#quote-card-'+i).find('.btn-success').on('click',(function(){
        	var imgPath = generateCustomImagePath;
        	var saved = true;
        	var custom = false;
        	(function(i){
        	addQuote(imgPath,decodeEntities(data[i].joke),saved,custom);
        	console.log(decodeEntities(data[i].joke))
        	})(i);

 
    			$.ajax({
            		url: "/quote/issaved",
            		method: "POST",
            		data : {
            			text : text
            		},
            		success : function(response){
            			if(response == true){
            				$('#quote-card-'+i).find('.btn-success').attr("disabled", true);
            			}
            			else{
            				$('#quote-card-'+i).find('.btn-success').removeAttr("disabled");
            			}
            		},
            		fail : function(){
            			alert("Something went terribly wrong!!!")
            		}
            	})
    		
        }))*/;
        $('#quote-container').append(template);
        template.show();
        }
        attachOnClickEvents();
        
    }
	
    
    
    
    
    
    function clearAllQuotes(){
     $("#quote-container").empty();
    }
    function getPersonalisedQuote(data){
        $("#result-personalised-quote").text(decodeEntities(data))
        $("#personalised-quote-container").show();
        $("#first-name").val("");
        $("#last-name").val("");
        $("#submit-personalised-quote").attr("disabled", true)


    }


    function getRandomQuote(data){
        $("#first-name").val("");
        $("#last-name").val("");
        $("#result-random-quote").text(decodeEntities(data))
        $("#random-quote-container").show();
        $("#submit-personalised-quote").attr("disabled", true)
    }
    function decodeEntities(encodedString) {
        var textArea = document.createElement('textarea');
        textArea.innerHTML = encodedString;
        return textArea.value;
      }

    function changeView(){
        var quotes = $("#quote-container>div");
        var images;
        if(quotes.length>0){
            
            images = $("#quote-container").find("img");
            button = $("#quote-container").find("button");
            if(quotes.hasClass("card")){
                quotes.removeClass("card");
                quotes.removeClass("m-2");
                quotes.removeClass("shadow");
                quotes.removeClass("card-quote");
                quotes.addClass("d-flex");
                quotes.addClass("border-top");
                quotes.addClass("w-100");
                images.addClass("thumbnail");
                images.removeClass("img-full-size");
                button.removeClass("mb-3");
                button.addClass("mt-3");
                button.removeClass("d-inline-block");
                button.addClass("d-block");
                button.addClass("w-100");
            }
            else{
                quotes.addClass("card");
                quotes.addClass("m-2");
                quotes.addClass("shadow");
                quotes.addClass("card-quote");
                quotes.removeClass("d-flex");
                quotes.removeClass("border-top");
                quotes.removeClass("w-100");
                images.removeClass("thumbnail");
                images.addClass("img-full-size");
                button.removeClass("mt-3");
                button.addClass("mb-3");
                button.addClass("d-inline-block");
                button.removeClass("d-block");
                button.removeClass("w-100");
            }
        }
    }
    function showChangeViewButton(){
        $("#change-view-btn").show();

    }
    function generateImage(img){
        var random = getRandomInt(7);
        var imgPath = "assets/images/"+random.toString()+".jpg";
        img.attr("src",imgPath);
        img.show();

    }
    function getRandomInt(max) {
        return 1+Math.floor(Math.random() * Math.floor(max));
      }
	function fetchData(filter){
    	switch(filter){
    	case "all":
			$.ajax({
        		url: "/quote/all",
        		method: "GET",
        		success : function(response){
					response.forEach(function(quote){
						postQuote(quote);
					})
        		},
        		fail : function(){
        			alert("Quotes were not retrieved")
        		}
        	});	
    		break;
    	case "saved":
    		$.ajax({
        		url: "/quote/saved",
        		method: "GET",
        		success : function(response){
					response.forEach(function(quote){
						postQuote(quote);
						console.log(response.length)
					})
        		},
        		fail : function(){
        			alert("Saved quotes were not retrieved")
        		}
        	});	
    		break;
    	case "custom":
    		$.ajax({
        		url: "/quote/custom",
        		method: "GET",
        		success : function(response){
					response.forEach(function(quote){
						postQuote(quote);
					})
        		},
        		fail : function(){
        			alert("Custom quotes were not retrieved")
        		}
        	});	
    		break;
    	}
    }
	function postQuote(quote){
        var template = $('#card-template').clone();
        template.attr('id', 'quote-card-'+quote.id);
        template.find('span').text(quote.text);
        var img = template.find('img');
        img.attr("src",quote.iconPath);
        img.show();
       var button = template.find('.btn-act')
       button.html("Remove");
       button.addClass("btn-danger");
       button.removeClass("btn-success");
       button.on('click',function(){
    	   			deleteQuoteById(quote.id,template);
					
        	})
                template.find('.btn-primary').on('click',function(){
                	
					 window.location.href='quote/edit/'+quote.id;
        	})
        $('#quote-container').append(template);
        template.show();
        
		
	}

    $('input[name="limit"]').click(function(){
      clearAllQuotes();
      showChangeViewButton();
      doApiRequest("")
    })
    $('input[name="filter"]').click(function(){
    	alert("clicked")
    	clearAllQuotes();
        showChangeViewButton();
      var filter = $('input[name="filter"]:checked').val();
    	console.log(filter);
      fetchData(filter);
    })
    $("#submit-random-quote").click(function(){
        doApiRequest("random")
    })
    $("#submit-personalised-quote").click(function(){
        doApiRequest("personalised")
        hasFName=false;
        hasLName=false;
    })
    $("#first-name").on("keydown", function(){
        if($("#first-name").val().length>0){
            hasFName = true;
        }
        else{
            hasFName = false;
        }
        if(hasFName && hasLName){
            $("#submit-personalised-quote").removeAttr("disabled")
        }
        else{
            $("#submit-personalised-quote").attr("disabled", true)
        }
    })
    $("#last-name").on("keydown", function(){
        if($("#last-name").val().length>0){
            hasLName = true;
        }
        else{
            hasLName =false;
        }
        if(hasFName && hasLName){
            $("#submit-personalised-quote").removeAttr("disabled")
        }
        else{
            $("#submit-personalised-quote").attr("disabled", true)
        }



    })
    $("#first-name").on("keyup", function(){
        if($("#first-name").val().length>0){
            hasFName = true;
        }
        else{
            hasFName = false;
        }
        if(hasFName && hasLName){
            $("#submit-personalised-quote").removeAttr("disabled")
        }
        else{
            $("#submit-personalised-quote").attr("disabled", true)
        }
    })
    $("#last-name").on("keyup", function(){
        if($("#last-name").val().length>0){
            hasLName = true;
        }
        else{
            hasLName =false;
        }
        if(hasFName && hasLName){
            $("#submit-personalised-quote").removeAttr("disabled")
        }
        else{
            $("#submit-personalised-quote").attr("disabled", true)
        }

    })
    $("#change-view-btn").click(function(){
        changeView();
    })
    function QueryBuilder(type){
        var fname="";
        var lname="";
        var limit="";
        var creds="";
        var apiLimit="";
        var apiType="";

        if(type === "random" || type ==="personalised"){
        apiType ="random";
        fname = $("#first-name").val();
        lname = $("#last-name").val();
        if(fname !=="" && lname !==""){
            creds = "firstName=" + fname + "&lastName=" + lname;
        }
        }
        else{
        apiType="";
        creds="";;
        }
       var limit = $('input[name="limit"]:checked').val();
       if(limit === undefined){
           limit="all";
       }
        switch(limit){
            case "nerdy": apiLimit ="?limitTo=[nerdy]";
            if(fname !=="" && lname !=="" && (type==="random" || type==="personalised")){
                creds = "&firstName=" + fname + "&lastName=" + lname};
             break;
            case "explicit": apiLimit ="?limitTo=[explicit]";
            if(fname !=="" && lname !=="" && (type==="random" || type==="personalised")){
                creds = "&firstName=" + fname + "&lastName=" + lname}; 
            break;
            case "all": apiLimit ="";
            if(fname !=="" && lname !=="" && (type==="random" || type==="personalised")){
                creds = "?firstName=" + fname + "&lastName=" + lname;
            }; break;
            default: apiLimit =""; break;
        }
        if(type === "random"){
            creds ="";
        }

        var query = "https://api.icndb.com/jokes/"+apiType+apiLimit+creds;
        return query;
    }
	$('#submit-custom-quote').click(function(){
		var quote = $('#custom-quote-text').val();
		var imgPath = generateCustomImagePath();
		addQuote(imgPath,quote,false,true)

		
		
	})
	function addQuote(imgPath,quote,saved,custom){
		if (quote.length>0){
			$.ajax({
        		url: "/quote/add",
        		method: "POST",
        		data : {
        			icon : imgPath,
        			text : quote,
        			saved : saved,
        			custom : custom
        		},
        		success : function(response){
        			if(response.includes("Error")){
        				//$('#result-custom-quote').text(response)
        				alert(response)
        			}
        			else{
        				
        				//$('#result-custom-quote').text("Quote has been created successfully")
        				alert("Quote has been created successfully")
        			}
        		},
        		fail : function(){
        			
        			alert("Something went terribly wrong!!!")
        		}
        	})
		}
		
	}
	function attachOnClickEvents(){
    	var saved = true;
    	var custom = false;
		var container = $('#quote-container');
		for (i=0; i <container.children().length; i++){
			(function(i){
			var imgPath = generateCustomImagePath;
			var text = $('#quote-card-'+i).find('span').text();
			
			$('#quote-card-'+i).find('.btn-act').on('click',function(){
				if($('#quote-card-'+i).find('.btn-act').html()==="Save"){
				addQuote(imgPath,text,saved,custom);
				//$('#quote-card-'+i).find('.btn-success').attr("disabled", true);
				$('#quote-card-'+i).find('.btn-act').html("Remove");
				$('#quote-card-'+i).find('.btn-act').addClass("btn-danger");
				$('#quote-card-'+i).find('.btn-act').removeClass("btn-success");
				
				}
				else{
					deleteQuote(text);
					$('#quote-card-'+i).find('.btn-act').html("Save");
    				$('#quote-card-'+i).find('.btn-act').addClass("btn-success");
    				$('#quote-card-'+i).find('.btn-act').removeClass("btn-danger");
				}
            	})
				
			})(i);
		}
		 
	 }
	function deleteQuoteById(id, template){
		 $.ajax({
	        	url: "/quote/deletebyId",
	        	method: "DELETE",
	        	data: {id : id},
	        	complete: function(data){
	        		if(data.status==200){
	        			alert("Delete Successful")
	        			template.remove();
	        		}
	        		if(data.status==401){
	        			alert("Delete Failed!!! You cant delete other people's quotes")
	        		}
	        		if(data.status==404){
	        			alert("Delete Failed!!! No such comment exists")
	        		}
	        		}
	        	})
	}
	
		function deleteQuote(text){
			 $.ajax({
		        	url: "/quote/delete",
		        	method: "DELETE",
		        	data: {text : text},
		        	complete: function(data){
		        		if(data.status==200){
		        			alert("Delete Successful")
		        		}
		        		if(data.status==401){
		        			alert("Delete Failed!!! You cant delete other people's quotes")
		        		}
		        		if(data.status==404){
		        			alert("Delete Failed!!! No such comment exists")
		        		}
		        		}
		        	})
		}
	    function generateCustomImagePath(){
        var random = getRandomInt(7);
        var imgPath = "assets/images/"+random.toString()+".jpg";
        return imgPath;
    }
	    
    })
    

    </script>
</html>